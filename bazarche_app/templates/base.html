{% load i18n %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    {% load static %}
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}SoodAva - بازار آنلاین افغانستان{% endblock %}</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="SoodAva - بازار آنلاین افغانستان. خرید و فروش محصولات، املاک، خودرو و خدمات در سراسر افغانستان. ثبت آگهی رایگان و امن.">
    <meta name="keywords" content="بازار, افغانستان, خرید, فروش, املاک, خودرو, موبایل, لپ‌تاپ, الکترونیک, خدمات, آگهی">
    <meta name="author" content="SoodAva">
    <meta name="robots" content="index, follow">
    <meta name="language" content="fa">
    <meta name="geo.region" content="AF">
    <meta name="geo.country" content="Afghanistan">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="SoodAva - بازار آنلاین افغانستان">
    <meta property="og:description" content="بازار آنلاین افغانستان برای خرید و فروش محصولات، املاک و خدمات">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://soodava.com">
    <meta property="og:site_name" content="SoodAva">
    <meta property="og:locale" content="fa_AF">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="SoodAva - بازار آنلاین افغانستان">
    <meta name="twitter:description" content="بازار آنلاین افغانستان برای خرید و فروش محصولات، املاک و خدمات">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#276ef1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SoodAva">
    <meta name="msapplication-TileColor" content="#276ef1">
    <meta name="msapplication-config" content="/static/browserconfig.xml">
    
    <!-- iOS Specific Meta Tags -->
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SoodAva">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="SoodAva">
    <meta name="msapplication-TileImage" content="{% static 'web-app-manifest-192x192.png' %}">
    <meta name="msapplication-TileColor" content="#276ef1">
    <meta name="msapplication-config" content="/static/browserconfig.xml">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{% static 'manifest.json' %}">
    
    <!-- Favicon & App Icons -->
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
    <link rel="icon" type="image/png" sizes="96x96" href="{% static 'favicon-96x96.png' %}">
    <link rel="icon" type="image/svg+xml" href="{% static 'favicon.svg' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'apple-touch-icon.png' %}">
    <link rel="apple-touch-icon" sizes="192x192" href="{% static 'web-app-manifest-192x192.png' %}">
    <link rel="apple-touch-icon" sizes="512x512" href="{% static 'web-app-manifest-512x512.png' %}">
    
    <!-- iOS Splash Screen -->
    <link rel="apple-touch-startup-image" media="screen and (device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3)" href="{% static 'apple-splash-1290x2796.png' %}">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3)" href="{% static 'apple-splash-1179x2556.png' %}">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3)" href="{% static 'apple-splash-1284x2778.png' %}">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)" href="{% static 'apple-splash-1170x2532.png' %}">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" href="{% static 'apple-splash-1125x2436.png' %}">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)" href="{% static 'apple-splash-828x1792.png' %}">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" href="{% static 'apple-splash-1125x2436.png' %}">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)" href="{% static 'apple-splash-828x1792.png' %}">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" href="{% static 'apple-splash-750x1334.png' %}">
    <link rel="apple-touch-startup-image" media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)" href="{% static 'apple-splash-640x1136.png' %}">
    <!-- حذف تگ‌های قدیمی لوگو -->
    <!-- PWA Icons -->
    <!-- <link rel="icon" type="image/png" href="{% static 'logo-1.png' %}"> -->
    <!-- <link rel="apple-touch-icon" href="{% static 'logo-1.png' %}"> -->
    <!-- <link rel="apple-touch-icon" sizes="152x152" href="{% static 'logo-1.png' %}"> -->
    <!-- <link rel="apple-touch-icon" sizes="180x180" href="{% static 'logo-1.png' %}"> -->
    <!-- <link rel="apple-touch-icon" sizes="167x167" href="{% static 'logo-1.png' %}"> -->
    <!-- <link rel="apple-touch-icon" sizes="120x120" href="{% static 'logo-1.png' %}"> -->
    <!-- <link rel="apple-touch-icon" sizes="76x76" href="{% static 'logo-1.png' %}"> -->
    <!-- <link rel="apple-touch-icon" sizes="60x60" href="{% static 'logo-1.png' %}"> -->
    <!-- <link rel="apple-touch-icon" sizes="40x40" href="{% static 'logo-1.png' %}"> -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{% static 'css/site-styles.css' %}">
    <link rel="stylesheet" href="{% static 'css/mobile-enhancements.css' %}">
    <link rel="stylesheet" href="{% static 'css/button-hierarchy.css' %}">
    {% block extra_head %}{% endblock %}
    <style>
      body {
        overflow-x: hidden;
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }
      
      /* Mobile-First Layout */
      .main-wrapper {
        margin-top: 80px; /* Space for fixed navbar */
        min-height: calc(100vh - 80px);
        background: #f8f9fa;
      }
      
      .landing-page .main-wrapper {
        margin-top: 0;
      }
      
      /* Content Container */
      .content-container {
        padding: 1rem;
        max-width: 1200px;
        margin: 0 auto;
      }
      
      @media (max-width: 768px) {
        .main-wrapper {
          margin-top: 70px;
        }
        
        .content-container {
          padding: 0.5rem;
        }
      }
      
      @media (max-width: 480px) {
        .main-wrapper {
          margin-top: 65px;
        }
        
        .content-container {
          padding: 0.25rem;
        }
      }
      
      /* Messages */
      .messages-container {
        position: fixed;
        top: 80px;
        left: 0;
        right: 0;
        z-index: 999;
        padding: 0.5rem 1rem;
      }
      

      
      .alert {
        border-radius: 12px;
        border: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-bottom: 0.5rem;
      }
      .ios-prompt-tip small {
        color: #666;
        line-height: 1.4;
      }
      
      .ios-prompt-image {
        margin-top: 20px;
        text-align: center;
      }
      
      .share-button-demo {
        display: inline-block;
        background: #276ef1;
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        box-shadow: 0 2px 8px rgba(39, 110, 241, 0.3);
        animation: pulse 2s infinite;
        font-size: 16px;
        min-width: 40px;
        text-align: center;
      }
      
      .share-button-real {
        display: inline-block;
        background: #007AFF;
        color: white;
        padding: 6px 8px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: normal;
        margin: 0 4px;
        box-shadow: 0 1px 3px rgba(0, 122, 255, 0.3);
        animation: pulse 2s infinite;
        min-width: 32px;
        height: 32px;
        text-align: center;
        line-height: 20px;
        border: none;
        vertical-align: middle;
      }
      
      .share-icon {
        font-size: 16px;
        margin-bottom: 0;
      }
      
      .share-text {
        font-size: 12px;
        font-weight: bold;
      }
      
      @keyframes pulse {
        0% {
          transform: scale(1);
          box-shadow: 0 4px 12px rgba(39, 110, 241, 0.3);
        }
        50% {
          transform: scale(1.05);
          box-shadow: 0 6px 20px rgba(39, 110, 241, 0.4);
        }
        100% {
          transform: scale(1);
          box-shadow: 0 4px 12px rgba(39, 110, 241, 0.3);
        }
      }
      .ios-prompt-tip {
        margin-top: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 6px;
        border-left: 3px solid #276ef1;
      }
    </style>
</head>
<body class="{% if request.resolver_match.url_name == 'landing' %}landing-page{% endif %}">
    <!-- Fixed Navbar -->
    {% include 'partials/navbar.html' %}

    <!-- Messages -->
    {% if messages %}
    <div class="messages-container">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Main Content -->
    <div class="main-wrapper">
        <div class="content-container">
            {% block content %}{% endblock %}
        </div>
        
        <!-- Sidebar Advertisements -->
        {% if sidebar_advertisements %}
        <div class="sidebar-advertisements" style="position: fixed; right: 20px; top: 50%; transform: translateY(-50%); width: 200px; z-index: 1000;">
            {% for advertisement in sidebar_advertisements %}
                <div class="sidebar-ad-item" style="margin-bottom: 1rem;">
                    {% include 'partials/advertisement.html' with advertisement=advertisement %}
                </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    
    <!-- Footer -->
    <footer class="bg-primary text-white text-center py-4 mt-4">
        <div class="soodava-brand" style="flex-direction:column;align-items:center;justify-content:center;">
          <span class="soodava-main" style="font-size:2rem;line-height:1.1;">SoodAva</span>
          <span class="soodava-sub" style="font-size:1rem;color:#fff;margin-top:0.1rem;">سود آوا</span>
        </div>
        <p class="mt-2">&copy; 2025 SoodAva. {% trans "تمام حقوق محفوظ است." %} | <a href="{% url 'app:terms' %}" class="text-white">{% trans "قوانین و مقررات" %}</a></p>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/site-enhancements.js' %}"></script>
    <script src="{% static 'js/mobile-enhancements.js' %}"></script>
    
    <!-- PWA Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/static/service-worker.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
        
        // iOS PWA Detection
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent);
        }
        
        function isStandalone() {
            return window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
        }
        

    </script>

        <!-- PWA Install Prompt -->
        <div id="pwa-install-prompt" class="pwa-prompt" style="display: none;">
            <div class="pwa-prompt-content">
                <div class="pwa-install-button" onclick="handleInstallClick()">
                    <span class="install-icon">📱</span>
                    <span class="install-text">نصب برنامه</span>
                </div>
                
                <!-- iOS Instructions (only shown on iOS) -->
                <div class="ios-install-instructions" id="ios-instructions" style="display: none;">
                    <div class="instructions-header">
                        <h6>📱 برای نصب اپلیکیشن</h6>
                        <button class="instructions-close" onclick="toggleIOSInstructions()">×</button>
                    </div>
                    <div class="instructions-steps">
                        <div class="step">
                            <div class="step-number">1</div>
                            <div class="step-text">روی دکمه <span class="share-button">⬆️</span> در پایین مرورگر کلیک کنید</div>
                        </div>
                        <div class="step">
                            <div class="step-number">2</div>
                            <div class="step-text">گزینه <strong>Add to Home Screen</strong> را انتخاب کنید</div>
                        </div>
                        <div class="step">
                            <div class="step-number">3</div>
                            <div class="step-text">روی دکمه <strong>Add</strong> کلیک کنید</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <style>
        .pwa-prompt {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            font-family: 'Vazir', sans-serif;
        }

        .pwa-prompt-content {
            position: relative;
        }

        .pwa-install-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            text-align: center;
            font-size: 12px;
            line-height: 1.2;
        }

        .pwa-install-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .pwa-install-button.expanded {
            width: 300px;
            height: auto;
            border-radius: 20px;
            padding: 20px;
        }

        .install-icon {
            font-size: 24px;
            margin-bottom: 5px;
            display: block;
        }

        .install-text {
            font-weight: bold;
        }

        .ios-install-instructions {
            position: absolute;
            bottom: 90px;
            right: 0;
            width: 280px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 20px;
            border: 2px solid #667eea;
        }

        .instructions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .instructions-header h6 {
            margin: 0;
            color: #333;
            font-weight: bold;
        }

        .instructions-close {
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .instructions-steps {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .step {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }

        .step-text {
            color: #555;
            line-height: 1.4;
            font-size: 14px;
        }

        .share-button {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .pwa-install-button {
                width: 70px;
                height: 70px;
                font-size: 11px;
            }
            
            .ios-install-instructions {
                width: 250px;
                right: -10px;
            }
        }
        </style>

        <script>
        // PWA Install Logic
        let deferredPrompt;
        
        // Listen for the beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            // Show the install button
            showInstallPrompt();
        });
        
        // Show install prompt
        function showInstallPrompt() {
            const prompt = document.getElementById('pwa-install-prompt');
            if (prompt) {
                prompt.style.display = 'block';
            }
        }
        
        // Handle install button click
        function handleInstallClick() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isStandalone = window.navigator.standalone;
            
            if (isIOS && !isStandalone) {
                // iOS: Show instructions
                toggleIOSInstructions();
            } else if (deferredPrompt) {
                // Android/Desktop: Trigger install prompt
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    } else {
                        console.log('User dismissed the install prompt');
                    }
                    deferredPrompt = null;
                    // Hide the install button after use
                    hideInstallPrompt();
                });
            } else {
                // Fallback: Show message
                alert('برای نصب برنامه، لطفاً از منوی مرورگر استفاده کنید.');
            }
        }
        
        // Toggle iOS instructions
        function toggleIOSInstructions() {
            const button = document.querySelector('.pwa-install-button');
            const instructions = document.getElementById('ios-instructions');
            
            if (instructions.style.display === 'none') {
                button.classList.add('expanded');
                instructions.style.display = 'block';
            } else {
                button.classList.remove('expanded');
                instructions.style.display = 'none';
            }
        }
        
        // Hide install prompt
        function hideInstallPrompt() {
            const prompt = document.getElementById('pwa-install-prompt');
            if (prompt) {
                prompt.style.display = 'none';
            }
        }
        
        // Check if app is already installed
        window.addEventListener('appinstalled', (evt) => {
            console.log('App was installed');
            hideInstallPrompt();
        });
        
        // Check if user is on iOS and show prompt
        function checkIOSAndShowPrompt() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isStandalone = window.navigator.standalone;
            
            if (isIOS && !isStandalone) {
                // Show prompt after 3 seconds on iOS
                setTimeout(showInstallPrompt, 3000);
            }
        }
        
        // Run on page load
        document.addEventListener('DOMContentLoaded', checkIOSAndShowPrompt);
        </script>
</body>
</html>
