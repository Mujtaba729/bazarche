{% extends 'base.html' %}
{% load i18n %}
{% load custom_filters %}

{% block title %}{% trans "خانه" %} - SoodAva{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Categories Section -->
    <div class="categories-section">
        <div class="categories-grid">
            {% for category in main_categories %}
            <a href="{% url 'app:category_detail' category.id %}" class="category-item">
                <div class="category-icon">
                    <i class="{{ category.icon }}"></i>
                </div>
                <span class="category-name">{{ category.name }}</span>
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- Products Section -->
    <div class="products-section">
        <div class="products-grid" id="products-grid">
            {% for product in products %}
                {% include 'partials/product_card.html' with product=product %}
            {% endfor %}
        </div>
        
        <!-- Loading indicator -->
        <div id="loading-indicator" style="display: none; text-align: center; padding: 2rem;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">در حال بارگذاری...</span>
            </div>
        </div>
    </div>
</div>

<!-- Back to Top Button -->
<div id="back-to-top" style="display: none;">
    <button type="button" class="btn btn-primary rounded-circle">
        <i class="bi bi-arrow-up"></i>
    </button>
</div>

<!-- Fixed Bottom Navigation -->
<div class="bottom-navbar">
    <div class="bottom-nav-container">
        <!-- Requests -->
        <a href="{% url 'app:requests_list' %}" class="bottom-nav-item">
            <div class="bottom-nav-icon">
                <i class="bi bi-list-ul"></i>
            </div>
            <span class="bottom-nav-label">درخواستی</span>
        </a>
        
        <!-- Jobs -->
        <a href="{% url 'app:jobs_list' %}" class="bottom-nav-item">
            <div class="bottom-nav-icon">
                <i class="bi bi-briefcase"></i>
            </div>
            <span class="bottom-nav-label">کاریابی</span>
        </a>
        
        <!-- Register Product (Center) -->
        <a href="{% url 'app:register_product' %}" class="bottom-nav-item">
            <div class="bottom-nav-icon">
                <i class="bi bi-plus-circle"></i>
            </div>
            <span class="bottom-nav-label">ثبت اگهی</span>
        </a>
        
        <!-- Language Dropdown -->
        <div class="bottom-nav-item dropdown" id="language-dropdown">
            <div class="dropdown-trigger" onclick="toggleLanguage()">
                <div class="bottom-nav-icon">
                    <i class="bi bi-translate"></i>
                </div>
                <span class="bottom-nav-label">زبان</span>
            </div>
            <div class="dropdown-menu" id="language-menu" style="display: none;">
                <a href="{% url 'app:set_language' %}?lang=fa" class="dropdown-item">فارسی</a>
                <a href="{% url 'app:set_language' %}?lang=en" class="dropdown-item">English</a>
                <a href="{% url 'app:set_language' %}?lang=ps" class="dropdown-item">پښتو</a>
            </div>
        </div>
        
        <!-- City Dropdown -->
        <div class="bottom-nav-item dropdown" id="city-dropdown">
            <div class="dropdown-trigger" onclick="toggleCity()">
                <div class="bottom-nav-icon">
                    <i class="bi bi-geo-alt"></i>
                </div>
                <span class="bottom-nav-label">شهر</span>
            </div>
            <div class="dropdown-menu" id="city-menu" style="display: none;">
                <a href="{% url 'app:home' %}" class="dropdown-item">همه شهرها</a>
                {% for city in cities %}
                <a href="{% url 'app:city_detail' city.id %}" class="dropdown-item">{{ city.name }}</a>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<style>
/* Mobile-First Design */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Vazir', Arial, sans-serif;
    background-color: #f8f9fa;
    padding-bottom: 5rem;
}

.container-fluid {
    padding: 0;
}

/* Categories Section */
.categories-section {
    background: #fff;
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 0 0 1rem 1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.categories-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.5rem;
}

.category-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-decoration: none;
    color: #333;
    padding: 0.5rem;
    border-radius: 0.5rem;
    transition: all 0.3s ease;
}

.category-item:hover {
    background-color: #f8f9fa;
    transform: translateY(-2px);
}

.category-icon {
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
    color: #007bff;
}

.category-name {
    font-size: 0.7rem;
    text-align: center;
    font-weight: 500;
}

/* Products Section */
.products-section {
    padding: 0 1rem;
}

.products-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
}

/* Product Card Styles */
.product-card {
    background: #fff;
    border-radius: 0.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: all 0.3s ease;
}

.product-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.product-link {
    text-decoration: none;
    color: inherit;
    display: block;
}

.product-image {
    width: 100%;
    height: 150px;
    overflow: hidden;
}

.product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.product-info {
    padding: 0.75rem;
}

.product-title {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #333;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.product-price {
    font-size: 0.8rem;
    color: #007bff;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.product-location {
    font-size: 0.7rem;
    color: #6c757d;
    margin: 0;
}

/* Back to Top Button */
#back-to-top {
    position: fixed;
    bottom: 6rem;
    right: 1rem;
    z-index: 1000;
}

#back-to-top button {
    width: 3rem;
    height: 3rem;
    border: none;
    background: #007bff;
    color: white;
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    transition: all 0.3s ease;
}

#back-to-top button:hover {
    background: #0056b3;
    transform: translateY(-2px);
}

/* Fixed Bottom Navigation */
.bottom-navbar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #fff;
    border-top: 1px solid #e9ecef;
    z-index: 1000;
    padding: 0.5rem 0;
}

.bottom-nav-container {
    display: flex;
    justify-content: space-around;
    align-items: center;
    max-width: 100%;
    margin: 0 auto;
}

.bottom-nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-decoration: none;
    color: #6c757d;
    transition: all 0.3s ease;
    padding: 0.5rem;
    border-radius: 0.5rem;
    min-width: 60px;
}

.bottom-nav-item:hover {
    color: #007bff;
    background-color: #f8f9fa;
}

.bottom-nav-icon {
    font-size: 1.2rem;
    margin-bottom: 0.25rem;
}

.bottom-nav-label {
    font-size: 0.7rem;
    font-weight: 500;
}


/* Dropdown Styles */
.dropdown {
    position: relative;
    cursor: pointer;
}

.dropdown-trigger {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-decoration: none;
    color: inherit;
    width: 100%;
    height: 100%;
    cursor: pointer;
}

.dropdown-menu {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    min-width: 120px;
    z-index: 99999;
    display: none;
    margin-bottom: 0.5rem;
    max-height: 200px;
    overflow-y: auto;
}

.dropdown-item {
    display: block;
    padding: 0.75rem 1rem;
    color: #333;
    text-decoration: none;
    font-size: 0.8rem;
    border-bottom: 1px solid #f8f9fa;
    transition: all 0.2s ease;
}

.dropdown-item:hover {
    background-color: #f8f9fa;
    color: #007bff;
}

.dropdown-item:last-child {
    border-bottom: none;
}

/* Responsive Design */
@media (min-width: 768px) {
    .products-grid {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .categories-grid {
        grid-template-columns: repeat(7, 1fr);
    }
}

@media (min-width: 992px) {
    .products-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}
</style>

<script>
// Simple dropdown functions
function toggleLanguage() {
    const langMenu = document.getElementById('language-menu');
    const cityMenu = document.getElementById('city-menu');
    
    // Close city menu
    if (cityMenu) {
        cityMenu.style.display = 'none';
    }
    
    // Toggle language menu
    if (langMenu) {
        if (langMenu.style.display === 'none') {
            langMenu.style.display = 'block';
        } else {
            langMenu.style.display = 'none';
        }
    }
}

function toggleCity() {
    const cityMenu = document.getElementById('city-menu');
    const langMenu = document.getElementById('language-menu');
    
    // Close language menu
    if (langMenu) {
        langMenu.style.display = 'none';
    }
    
    // Toggle city menu
    if (cityMenu) {
        if (cityMenu.style.display === 'none') {
            cityMenu.style.display = 'block';
        } else {
            cityMenu.style.display = 'none';
        }
    }
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('#language-dropdown')) {
        const langMenu = document.getElementById('language-menu');
        if (langMenu) {
            langMenu.style.display = 'none';
        }
    }
    
    if (!e.target.closest('#city-dropdown')) {
        const cityMenu = document.getElementById('city-menu');
        if (cityMenu) {
            cityMenu.style.display = 'none';
        }
    }
});

// Back to top functionality
window.addEventListener('scroll', function() {
    const backToTop = document.getElementById('back-to-top');
    if (window.pageYOffset > 300) {
        backToTop.style.display = 'block';
    } else {
        backToTop.style.display = 'none';
    }
});

document.getElementById('back-to-top').addEventListener('click', function() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
});

// Infinite scroll functionality
let currentPage = 1;
let isLoading = false;
let hasMoreProducts = true;

function loadMoreProducts() {
    if (isLoading || !hasMoreProducts) return;
    
    isLoading = true;
    const loadingIndicator = document.getElementById('loading-indicator');
    if (loadingIndicator) {
        loadingIndicator.style.display = 'block';
    }
    
    fetch(`/app/load-more-products/?page=${currentPage + 1}`)
        .then(response => response.json())
        .then(data => {
            if (data.products && data.products.length > 0) {
                const productsGrid = document.getElementById('products-grid');
                if (productsGrid) {
                    data.products.forEach(product => {
                        const productCard = createProductCard(product);
                        productsGrid.appendChild(productCard);
                    });
                    currentPage++;
                }
            } else {
                hasMoreProducts = false;
            }
        })
        .catch(error => {
            console.error('Error loading more products:', error);
        })
        .finally(() => {
            isLoading = false;
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
        });
}

function createProductCard(product) {
    const div = document.createElement('div');
    div.className = 'product-card';
    div.innerHTML = `
        <a href="/app/product/${product.id}/" class="product-link">
            <div class="product-image">
                <img src="${product.image || '/static/images/placeholder.jpg'}" alt="${product.name}" loading="lazy">
            </div>
            <div class="product-info">
                <h3 class="product-title">${product.name}</h3>
                <p class="product-price">${product.price ? product.price.toLocaleString() + ' افغانی' : 'قیمت توافقی'}</p>
                <p class="product-location">${product.city}</p>
            </div>
        </a>
    `;
    return div;
}

// Intersection Observer for infinite scroll
const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting && hasMoreProducts && !isLoading) {
            loadMoreProducts();
        }
    });
}, {
    rootMargin: '100px'
});

// Start observing when page loads
document.addEventListener('DOMContentLoaded', function() {
    const loadingIndicator = document.getElementById('loading-indicator');
    if (loadingIndicator) {
        observer.observe(loadingIndicator);
    }
});
</script>
{% endblock %}
