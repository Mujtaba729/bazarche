{% load i18n %}
{% load static %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css">
<style>
/* Modern Mobile-First Navbar */
.mobile-navbar {
    background: #fff;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #f1f3f4;
}

.navbar-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
}

/* Logo Section */
.navbar-brand {
    display: flex;
    align-items: center;
    text-decoration: none;
    color: #2c3e50;
    font-weight: 700;
    font-size: 1rem; /* Smaller font */
}

.navbar-brand img {
    height: 28px; /* Smaller logo */
    width: auto;
    margin-left: 0.5rem;
    object-fit: contain;
    display: block;
}

/* Navigation Menu */
.nav-menu {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.nav-btn {
    background: none;
    border: none;
    padding: 0.4rem; /* Smaller padding */
    border-radius: 6px; /* Smaller border radius */
    color: #6c757d;
    font-size: 1rem; /* Smaller icon */
    transition: all 0.3s ease;
    position: relative;
}

.nav-btn:hover {
    background: #f8f9fa;
    color: #667eea;
}

.nav-btn.active {
    color: #667eea;
    background: rgba(102, 126, 234, 0.1);
}

/* User Menu */
.user-menu {
    position: relative;
}

.user-btn {
    background: #667eea;
    border: none;
    border-radius: 6px; /* Smaller border radius */
    padding: 0.4rem 0.6rem; /* Smaller padding */
    color: #fff;
    font-size: 0.8rem; /* Smaller font */
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.2rem; /* Smaller gap */
}

.user-btn:hover {
    background: #5a6fd8;
    transform: translateY(-1px);
}

/* Dropdown Menus */
.dropdown-menu {
    position: absolute;
    top: 100%;
    right: 0;
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    padding: 0.5rem;
    min-width: 200px;
    z-index: 1001;
    margin-top: 0.5rem;
}

.dropdown-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    color: #2c3e50;
    text-decoration: none;
    border-radius: 8px;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.dropdown-item:hover {
    background: #f8f9fa;
    color: #667eea;
}

.dropdown-item.active {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
}

.dropdown-divider {
    margin: 0.5rem 0;
    border-color: #e9ecef;
}

/* City Dropdown Specific Styles */
.city-dropdown {
    max-height: 300px !important;
    overflow-y: auto !important;
    scrollbar-width: thin;
    scrollbar-color: #667eea #f8f9fa;
}

.city-dropdown::-webkit-scrollbar {
    width: 6px;
}

.city-dropdown::-webkit-scrollbar-track {
    background: #f8f9fa;
    border-radius: 3px;
}

.city-dropdown::-webkit-scrollbar-thumb {
    background: #667eea;
    border-radius: 3px;
}

.city-dropdown::-webkit-scrollbar-thumb:hover {
    background: #5a6fd8;
}

/* Mobile Menu */
.mobile-menu-toggle {
    display: none;
    background: none;
    border: none;
    padding: 0.5rem;
    border-radius: 8px;
    color: #6c757d;
    font-size: 1.2rem;
    transition: all 0.3s ease;
}

.mobile-menu-toggle:hover {
    background: #f8f9fa;
    color: #667eea;
}

.mobile-menu {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1002;
    display: none;
}

.mobile-menu.show {
    display: block;
}

.mobile-menu-content {
    position: absolute;
    top: 0;
    right: 0;
    width: 280px;
    height: 100%;
    background: #fff;
    padding: 1rem;
    overflow-y: auto;
    transform: translateX(100%);
    transition: transform 0.3s ease;
}

.mobile-menu.show .mobile-menu-content {
    transform: translateX(0);
}

.mobile-menu-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e9ecef;
    margin-bottom: 1rem;
}

.mobile-menu-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #6c757d;
    padding: 0.25rem;
}

.mobile-menu-nav {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.mobile-nav-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    color: #2c3e50;
    text-decoration: none;
    border-radius: 8px;
    transition: all 0.3s ease;
    font-size: 1rem;
}

.mobile-nav-item:hover {
    background: #f8f9fa;
    color: #667eea;
}

.mobile-nav-item.active {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
}

/* Mobile City Selection Styles */
.mobile-city-section {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1rem;
    margin: 1rem 0;
    border: 1px solid #e9ecef;
}

/* Mobile Language Selection Styles */
.mobile-language-section {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1rem;
    margin: 1rem 0;
    border: 1px solid #e9ecef;
}

.mobile-language-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.75rem;
    font-size: 0.9rem;
}

.mobile-language-header i {
    color: #667eea;
    font-size: 1rem;
}

.mobile-language-options {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.mobile-language-option {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    color: #2c3e50;
    text-decoration: none;
    border-radius: 8px;
    transition: all 0.3s ease;
    font-size: 0.85rem;
    background: #fff;
    border: 1px solid #e9ecef;
}

.mobile-language-option:hover {
    background: #667eea;
    color: #fff;
    text-decoration: none;
}

.mobile-language-option.active {
    background: #667eea;
    color: #fff;
}

@media (max-width: 480px) {
    .mobile-city-section {
        padding: 0.75rem;
        margin: 0.75rem 0;
    }
    
    .mobile-city-header {
        font-size: 0.85rem;
    }
    
    .mobile-city-option {
        padding: 0.6rem;
        font-size: 0.8rem;
    }
    
    .current-city {
        font-size: 0.85rem;
    }
}

.mobile-city-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.75rem;
    font-size: 0.9rem;
}

.mobile-city-header i {
    color: #667eea;
    font-size: 1rem;
}

.mobile-city-current {
    background: #fff;
    border-radius: 8px;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    border: 1px solid #e9ecef;
}

.current-city {
    font-weight: 600;
    color: #667eea;
    font-size: 0.9rem;
}

.mobile-city-options {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    max-height: 200px;
    overflow-y: auto;
}

.mobile-city-option {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    color: #2c3e50;
    text-decoration: none;
    border-radius: 8px;
    transition: all 0.3s ease;
    font-size: 0.85rem;
    background: #fff;
    border: 1px solid #e9ecef;
}

.mobile-city-option:hover {
    background: #667eea;
    color: #fff;
    text-decoration: none;
}

.mobile-city-option.active {
    background: #667eea;
    color: #fff;
}

.mobile-city-option i {
    font-size: 0.8rem;
}

/* Responsive Design */
@media (max-width: 768px) {
    .mobile-navbar {
        padding: 0.4rem 0.6rem; /* Smaller padding */
    }
    
    .navbar-container {
        gap: 0.4rem; /* Smaller gap */
    }
    
    .navbar-brand {
        font-size: 0.8rem; /* Smaller font */
        flex-shrink: 0;
    }
    
    .navbar-brand img {
        height: 20px; /* Smaller logo */
        width: auto;
        object-fit: contain;
        display: block;
    }
    
    .soodava-main {
        font-size: 1.4rem !important;
    }
    
    .soodava-sub {
        font-size: 0.7rem !important;
    }
    
    .search-section {
        max-width: none;
        flex: 1;
        margin-left: 8px;
        margin-right: 8px;
    }
    
    .search-form {
        position: relative !important;
        width: 100%;
        display: flex;
        align-items: center;
    }
    
    .search-input {
        padding: 0.5rem 0.6rem 0.5rem 2.2rem !important; /* پدینگ چپ برای دکمه گرد */
        font-size: 0.8rem; /* Smaller font */
    }
    
    .nav-menu {
        display: none;
    }
    
    .mobile-menu-toggle {
        display: block;
    }
    
    .mobile-notification-btn {
        display: flex !important;
        align-items: center;
    }
}

@media (max-width: 480px) {
    .mobile-navbar {
        padding: 0.3rem 0.5rem; /* Even smaller padding */
    }
    
    .navbar-brand {
        font-size: 0.7rem; /* Smaller font */
    }
    
    .navbar-brand img {
        height: 18px; /* Smaller logo */
        width: auto;
        object-fit: contain;
        display: block;
    }
    
    .soodava-main {
        font-size: 1.2rem !important;
    }
    
    .soodava-sub {
        font-size: 0.6rem !important;
    }
    
    .search-input {
        padding: 0.4rem 0.5rem; /* Smaller padding */
        font-size: 0.75rem; /* Smaller font */
    }
    
    .search-btn {
        position: absolute !important;
        left: 0.3rem !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
        background: #667eea !important;
        border: none !important;
        border-radius: 50% !important;
        padding: 0.35rem !important;
        color: #fff !important;
        font-size: 0.7rem !important;
        width: 24px !important;
        height: 24px !important;
        min-width: 24px !important;
        min-height: 24px !important;
        z-index: 10 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }
}

/* Notification Styles */
.notification-menu {
    position: relative;
}

.mobile-notification-btn {
    position: relative;
    margin-left: 8px;
}

.mobile-notification-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    width: 280px;
    max-height: 300px;
    z-index: 1001;
    margin-top: 8px;
    transform: translateX(0);
}

@media (max-width: 480px) {
    .mobile-notification-dropdown {
        right: -250px;
        width: 250px;
    }
}

@media (max-width: 360px) {
    .mobile-notification-dropdown {
        right: -270px;
        width: 220px;
    }
}

.notification-btn {
    position: relative;
}

.notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #dc3545;
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    animation: pulse 2s infinite;
}

.notification-dropdown {
    width: 320px;
    max-height: 400px;
    overflow-y: auto;
}

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e9ecef;
    background: #f8f9fa;
    border-radius: 12px 12px 0 0;
}

.notification-header h6 {
    margin: 0;
    font-weight: 600;
    color: #2c3e50;
}

.view-all-link {
    color: #667eea;
    text-decoration: none;
    font-size: 0.85rem;
    font-weight: 500;
}

.view-all-link:hover {
    text-decoration: underline;
}

.notification-list {
    max-height: 300px;
    overflow-y: auto;
}

.notification-loading {
    padding: 1rem;
    text-align: center;
    color: #6c757d;
    font-size: 0.9rem;
}

.notification-item {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #f1f3f4;
    transition: background 0.3s ease;
}

.notification-item:hover {
    background: #f8f9fa;
}

.notification-item:last-child {
    border-bottom: none;
}

.notification-item.unread {
    background: #e3f2fd;
    border-right: 3px solid #2196f3;
}

.notification-content {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
}

.notification-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    color: white;
    flex-shrink: 0;
}

.notification-icon.comment {
    background: #28a745;
}

.notification-icon.admin {
    background: #dc3545;
}

.notification-icon.chat {
    background: #17a2b8;
}

.notification-text {
    flex: 1;
    font-size: 0.85rem;
    line-height: 1.4;
    color: #2c3e50;
}

.notification-time {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

@keyframes pulse {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.1);
    }
    100% {
        transform: scale(1);
    }
}

/* Touch-friendly improvements */
@media (hover: none) and (pointer: coarse) {
    .nav-btn:hover,
    .user-btn:hover,
    .dropdown-item:hover,
    .mobile-nav-item:hover {
        transform: none;
    }
    
    .nav-btn:active,
    .user-btn:active,
    .dropdown-item:active,
    .mobile-nav-item:active {
        transform: scale(0.95);
    }
}
</style>

<nav class="mobile-navbar">
    <div class="navbar-container">
        <!-- Logo -->
        <a class="navbar-brand" href="{% url 'app:home' %}">
            <span class="soodava-brand" style="display:flex;flex-direction:column;align-items:flex-start;">
              <span class="soodava-main" style="font-size:1.8rem;line-height:1.1;background:linear-gradient(45deg, #1976d2, #43a047);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-weight:900;">
                SoodAva
              </span>
              <span class="soodava-sub" style="font-size:0.85rem;color:#666;margin-top:0.1rem;font-weight:600;">سود آوا</span>
            </span>
        </a>
        
        <!-- Search -->
        <div class="search-section">
            <form class="search-form" method="get" action="{% url 'app:home' %}#products">
                <input type="text" class="search-input" name="q" placeholder="{% trans 'جستجو' %}..." value="{{ search_query|default:'' }}">
                <button type="submit" class="search-btn">
                    <i class="bi bi-search"></i>
                </button>
            </form>
        </div>
        
        <!-- Mobile Notification Button -->
        {% if user.is_authenticated %}
        <div class="mobile-notification-btn d-md-none">
            <button class="nav-btn notification-btn" onclick="toggleNotificationDropdown()" title="{% trans 'اعلان‌ها' %}">
                <i class="bi bi-bell"></i>
                <span class="notification-badge" id="mobileNotificationBadge" style="display: none;">0</span>
            </button>
            <div class="dropdown-menu notification-dropdown mobile-notification-dropdown" id="mobileNotificationDropdown" style="display: none;">
                <div class="notification-header">
                    <h6>{% trans "اعلان‌ها" %}</h6>
                </div>
                <div class="notification-list" id="mobileNotificationList">
                    <div class="notification-loading">
                        <i class="bi bi-hourglass-split"></i>
                        {% trans "در حال بارگذاری..." %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Desktop Navigation -->
        <div class="nav-menu d-none d-md-flex">
            <!-- Home Button -->
            <a href="{% url 'app:home' %}" class="nav-btn {% if request.path == '/' %}active{% endif %}" title="{% trans 'خانه' %}">
                <i class="bi bi-house-door"></i>
            </a>
            
            
            <!-- About Us Button -->
            <a href="{% url 'app:about' %}" class="nav-btn {% if request.path == '/app/about/' %}active{% endif %}" title="{% trans 'درباره ما' %}">
                <i class="bi bi-info-circle"></i>
            </a>
            
            {% if user.is_authenticated %}
            <!-- Notification Button -->
            <div class="notification-menu">
                <button class="nav-btn notification-btn" onclick="toggleNotificationDropdown()" title="{% trans 'اعلان‌ها' %}">
                    <i class="bi bi-bell"></i>
                    <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                </button>
                <div class="dropdown-menu notification-dropdown" id="notificationDropdown" style="display: none;">
                    <div class="notification-header">
                        <h6>{% trans "اعلان‌ها" %}</h6>
                        <a href="{% url 'app:notifications' %}" class="view-all-link">{% trans "مشاهده همه" %}</a>
                    </div>
                    <div class="notification-list" id="notificationList">
                        <div class="notification-loading">
                            <i class="bi bi-hourglass-split"></i>
                            {% trans "در حال بارگذاری..." %}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="user-menu">
                <button class="user-btn" onclick="toggleUserDropdown()">
                    <i class="bi bi-person"></i>
                    <span>{% trans "حساب من" %}</span>
                </button>
                <div class="dropdown-menu" id="userDropdown" style="display: none;">
                    <a href="{% url 'app:user_dashboard' %}" class="dropdown-item">
                        <i class="bi bi-person"></i>
                        {% trans "پروفایل" %}
                    </a>
                    <a href="{% url 'app:notifications' %}" class="dropdown-item">
                        <i class="bi bi-bell"></i>
                        {% trans "اعلان‌ها" %}
                    </a>
                </div>
            </div>
            {% else %}
            <a href="{% url 'login' %}" class="nav-btn">
                <i class="bi bi-box-arrow-in-right"></i>
            </a>
            <a href="{% url 'app:register_user' %}" class="nav-btn">
                <i class="bi bi-person-plus"></i>
            </a>
            {% endif %}
        </div>
        
        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle d-md-none" onclick="toggleMobileMenu()">
            <i class="bi bi-list"></i>
        </button>
    </div>
    
    <!-- City Dropdown -->
    <div class="dropdown-menu city-dropdown" id="cityDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; margin-top: 0.5rem; max-height: 300px; overflow-y: auto;">
        <a href="{% url 'app:home' %}" class="dropdown-item">
            <i class="bi bi-globe"></i>
            {% trans "همه شهرها" %}
        </a>
        <hr class="dropdown-divider">
        {% for city in cities %}
        <a href="{% url 'app:home' %}?city_id={{ city.id }}" class="dropdown-item {% if selected_city_id == city.id|stringformat:'s' %}active{% endif %}">
            <i class="bi bi-geo-alt"></i>
            {{ city.name }}
        </a>
        {% endfor %}
    </div>
    
</nav>

<!-- Mobile Menu -->
<div class="mobile-menu" id="mobileMenu">
    <div class="mobile-menu-content">
        <div class="mobile-menu-header">
            <h5>{% trans "منو" %}</h5>
            <button class="mobile-menu-close" onclick="toggleMobileMenu()">
                <i class="bi bi-x"></i>
            </button>
        </div>
        
        <div class="mobile-menu-nav">
            
            <a href="{% url 'app:home' %}" class="mobile-nav-item {% if request.path == '/' %}active{% endif %}">
                <i class="bi bi-house-door"></i>
                {% trans "خانه" %}
            </a>
            
            
            {% if user.is_authenticated %}
                                <a href="{% url 'app:user_dashboard' %}" class="mobile-nav-item">
                        <i class="bi bi-person"></i>
                        {% trans "پروفایل من" %}
                    </a>
            {% else %}
            <a href="{% url 'login' %}" class="mobile-nav-item">
                <i class="bi bi-box-arrow-in-right"></i>
                {% trans "ورود" %}
            </a>
            <a href="{% url 'app:register_user' %}" class="mobile-nav-item">
                <i class="bi bi-person-plus"></i>
                {% trans "ثبت نام" %}
            </a>
            {% endif %}
            
            <hr class="dropdown-divider">
            
            <a href="{% url 'app:about' %}" class="mobile-nav-item {% if request.path == '/app/about/' %}active{% endif %}">
                <i class="bi bi-info-circle"></i>
                {% trans "درباره ما" %}
            </a>
            <a href="{% url 'app:contact' %}" class="mobile-nav-item {% if request.path == '/app/contact/' %}active{% endif %}">
                <i class="bi bi-envelope"></i>
                {% trans "تماس با ما" %}
            </a>
        </div>
    </div>
</div>

<script>
function toggleLanguageDropdown() {
    const dropdown = document.getElementById('languageDropdown');
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

function toggleCityDropdown() {
    const dropdown = document.getElementById('cityDropdown');
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}



function toggleNotificationDropdown() {
    // Desktop dropdown
    const desktopDropdown = document.getElementById('notificationDropdown');
    const mobileDropdown = document.getElementById('mobileNotificationDropdown');
    
    // Check if mobile dropdown exists and is visible
    const isMobileVisible = mobileDropdown && mobileDropdown.style.display === 'block';
    const isDesktopVisible = desktopDropdown && desktopDropdown.style.display === 'block';
    
    if (isMobileVisible || isDesktopVisible) {
        // Close both dropdowns
        if (desktopDropdown) desktopDropdown.style.display = 'none';
        if (mobileDropdown) mobileDropdown.style.display = 'none';
    } else {
        // Open appropriate dropdown
        if (window.innerWidth < 768) {
            // Mobile
            if (mobileDropdown) {
                mobileDropdown.style.display = 'block';
                loadMobileNotifications();
            }
        } else {
            // Desktop
            if (desktopDropdown) {
                desktopDropdown.style.display = 'block';
                loadNotifications();
            }
        }
    }
}

function toggleUserDropdown() {
    const dropdown = document.getElementById('userDropdown');
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

function toggleMobileMenu() {
    const menu = document.getElementById('mobileMenu');
    menu.classList.toggle('show');
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    const languageDropdown = document.getElementById('languageDropdown');
    const cityDropdown = document.getElementById('cityDropdown');
    const userDropdown = document.getElementById('userDropdown');

    
    if (!event.target.closest('.language-menu') && !event.target.closest('#languageDropdown')) {
        if (languageDropdown) languageDropdown.style.display = 'none';
    }
    
    if (!event.target.closest('.nav-btn') && !event.target.closest('#cityDropdown')) {
        if (cityDropdown) cityDropdown.style.display = 'none';
    }
    

    
    if (!event.target.closest('.user-menu') && !event.target.closest('#userDropdown')) {
        if (userDropdown) userDropdown.style.display = 'none';
    }
});

// Prevent dropdown from closing when scrolling inside it
document.addEventListener('scroll', function(event) {
    const cityDropdown = document.getElementById('cityDropdown');
    if (cityDropdown && cityDropdown.style.display === 'block') {
        event.stopPropagation();
    }
});

// Close mobile menu when clicking outside
document.addEventListener('click', function(event) {
    const mobileMenu = document.getElementById('mobileMenu');
    if (!event.target.closest('.mobile-menu-content') && !event.target.closest('.mobile-menu-toggle')) {
        mobileMenu.classList.remove('show');
    }
});

// Notification Functions
function loadNotifications() {
    const notificationList = document.getElementById('notificationList');
    notificationList.innerHTML = '<div class="notification-loading"><i class="bi bi-hourglass-split"></i> در حال بارگذاری...</div>';
    
    fetch('/app/api/notifications/recent/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayNotifications(data.notifications, 'notificationList');
            } else {
                notificationList.innerHTML = '<div class="notification-loading">خطا در بارگذاری اعلان‌ها</div>';
            }
        })
        .catch(error => {
            console.error('Error loading notifications:', error);
            notificationList.innerHTML = '<div class="notification-loading">خطا در بارگذاری اعلان‌ها</div>';
        });
}

function loadMobileNotifications() {
    const notificationList = document.getElementById('mobileNotificationList');
    notificationList.innerHTML = '<div class="notification-loading"><i class="bi bi-hourglass-split"></i> در حال بارگذاری...</div>';
    
    fetch('/app/api/notifications/recent/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayNotifications(data.notifications, 'mobileNotificationList');
            } else {
                notificationList.innerHTML = '<div class="notification-loading">خطا در بارگذاری اعلان‌ها</div>';
            }
        })
        .catch(error => {
            console.error('Error loading notifications:', error);
            notificationList.innerHTML = '<div class="notification-loading">خطا در بارگذاری اعلان‌ها</div>';
        });
}

function displayNotifications(notifications, listId) {
    const notificationList = document.getElementById(listId);
    
    if (notifications.length === 0) {
        notificationList.innerHTML = '<div class="notification-loading"><i class="bi bi-bell-slash"></i> هیچ اعلانی موجود نیست</div>';
        return;
    }
    
    let html = '';
    notifications.forEach(notification => {
        const iconClass = getNotificationIcon(notification.subject);
        const timeAgo = getTimeAgo(notification.timestamp);
        
        html += `
            <div class="notification-item ${!notification.is_read ? 'unread' : ''}" data-id="${notification.id}">
                <div class="notification-content">
                    <div class="notification-icon ${iconClass}">
                        <i class="bi ${getNotificationIconClass(notification.subject)}"></i>
                    </div>
                    <div class="notification-text">
                        ${notification.message}
                        <div class="notification-time">${timeAgo}</div>
                    </div>
                </div>
            </div>
        `;
    });
    
    notificationList.innerHTML = html;
}

function getNotificationIcon(subject) {
    if (subject.includes('COMMENT')) return 'comment';
    if (subject.includes('ADMIN')) return 'admin';
    if (subject.includes('CHAT')) return 'chat';
    return 'comment';
}

function getNotificationIconClass(subject) {
    if (subject.includes('COMMENT')) return 'bi-chat-dots';
    if (subject.includes('ADMIN')) return 'bi-shield-check';
    if (subject.includes('CHAT')) return 'bi-chat';
    return 'bi-bell';
}

function getTimeAgo(timestamp) {
    const now = new Date();
    const time = new Date(timestamp);
    const diff = now - time;
    
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return 'همین الان';
    if (minutes < 60) return `${minutes} دقیقه پیش`;
    if (hours < 24) return `${hours} ساعت پیش`;
    if (days < 7) return `${days} روز پیش`;
    
    return time.toLocaleDateString('fa-IR');
}

function updateNotificationCount() {
    fetch('/app/api/notifications/count/')
        .then(response => response.json())
        .then(data => {
            // Update desktop notification badge
            const desktopBadge = document.getElementById('notificationBadge');
            if (desktopBadge) {
                if (data.count > 0) {
                    desktopBadge.textContent = data.count > 99 ? '99+' : data.count;
                    desktopBadge.style.display = 'flex';
                } else {
                    desktopBadge.style.display = 'none';
                }
            }
            
            // Update mobile notification badge
            const mobileBadge = document.getElementById('mobileNotificationBadge');
            if (mobileBadge) {
                if (data.count > 0) {
                    mobileBadge.textContent = data.count > 99 ? '99+' : data.count;
                    mobileBadge.style.display = 'flex';
                } else {
                    mobileBadge.style.display = 'none';
                }
            }
        })
        .catch(error => {
            console.error('Error updating notification count:', error);
        });
}

// Load notification count on page load
document.addEventListener('DOMContentLoaded', function() {
    updateNotificationCount();
    
    // Update notification count every 30 seconds
    setInterval(updateNotificationCount, 30000);
});

// Close notification dropdown when clicking outside
document.addEventListener('click', function(event) {
    const desktopDropdown = document.getElementById('notificationDropdown');
    const mobileDropdown = document.getElementById('mobileNotificationDropdown');
    const notificationMenu = document.querySelector('.notification-menu');
    const mobileNotificationBtn = document.querySelector('.mobile-notification-btn');
    
    // Close desktop dropdown
    if (desktopDropdown && !event.target.closest('.notification-menu') && !event.target.closest('#notificationDropdown')) {
        desktopDropdown.style.display = 'none';
    }
    
    // Close mobile dropdown
    if (mobileDropdown && !event.target.closest('.mobile-notification-btn') && !event.target.closest('#mobileNotificationDropdown')) {
        mobileDropdown.style.display = 'none';
    }
});
</script>
