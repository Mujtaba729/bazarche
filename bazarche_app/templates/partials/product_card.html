{% load static %}
{% load i18n %}
{% load humanize %}

<style>
/* Modern Mobile Product Card - Compact Design */
.product-card {
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    transition: all 0.2s ease;
    border: 1px solid #f1f3f4;
    height: 100%;
    display: flex;
    flex-direction: column;
    position: relative;
}

.product-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
}

.product-image-container {
    position: relative;
    width: 100%;
    height: 120px; /* Reduced height for compact design */
    overflow: hidden;
}

.product-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.product-card:hover .product-image {
    transform: scale(1.05);
}

.product-badge {
    position: absolute;
    top: 4px;
    right: 4px;
    padding: 2px 6px;
    border-radius: 6px;
    font-size: 0.6rem; /* Smaller font */
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    z-index: 2;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.badge-featured {
    background: linear-gradient(45deg, #FFD700, #FFA500);
    color: #000;
}

.badge-discounted {
    background: linear-gradient(45deg, #FF4B4B, #FF6B6B);
    color: #fff;
}

.badge-suggested {
    background: linear-gradient(45deg, #4CAF50, #45a049);
    color: #fff;
}

.delete-button {
    position: absolute;
    top: 4px;
    left: 4px;
    z-index: 3;
    background: rgba(220, 53, 69, 0.9);
    color: white !important;
    border: none;
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 0.6rem; /* Smaller font */
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(4px);
    text-decoration: none;
    display: inline-block;
}

.delete-button:hover {
    background: rgba(220, 53, 69, 1);
    transform: scale(1.05);
    color: white !important;
    text-decoration: none;
}

.product-content {
    padding: 8px; /* Reduced padding */
    flex-grow: 1;
    display: flex;
    flex-direction: column;
}

.product-title {
    font-size: 0.8rem; /* Smaller font */
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 4px;
    line-height: 1.2;
    height: 2.4em;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.product-tags {
    display: flex;
    gap: 3px;
    margin-bottom: 6px;
    flex-wrap: wrap;
}

.condition-badge {
    padding: 1px 4px;
    border-radius: 3px;
    font-size: 0.55rem; /* Smaller font */
    font-weight: 500;
}

.badge-new {
    background: #e8f5e9;
    color: #2e7d32;
    border: 1px solid #c8e6c9;
}

.badge-used {
    background: #fff3e0;
    color: #ef6c00;
    border: 1px solid #ffe0b2;
}

.product-meta {
    font-size: 0.65rem; /* Smaller font */
    color: #6c757d;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 3px;
}

.product-meta i {
    font-size: 0.6rem; /* Smaller icon */
}

.product-price {
    margin-top: auto;
    padding-top: 6px;
    border-top: 1px solid #f1f3f4;
}

.price-container {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-bottom: 3px;
}

.original-price {
    font-size: 0.65rem; /* Smaller font */
    color: #6c757d;
    text-decoration: line-through;
}

.discount-price {
    font-size: 0.85rem; /* Smaller font */
    font-weight: 700;
    color: #e74c3c;
}

.current-price {
    font-size: 0.85rem; /* Smaller font */
    font-weight: 700;
    color: #667eea;
}

.location {
    font-size: 0.65rem; /* Smaller font */
    color: #6c757d;
    display: flex;
    align-items: center;
    gap: 3px;
}

.location i {
    font-size: 0.6rem; /* Smaller icon */
}



/* Responsive Design - Mobile First */
@media (max-width: 480px) {
    .product-image-container {
        height: 100px; /* Even smaller for mobile */
    }
    
    .product-content {
        padding: 6px; /* Reduced padding */
    }
    
    .product-title {
        font-size: 0.75rem;
        height: 2.4em;
    }
    
    .product-badge {
        font-size: 0.55rem;
        padding: 2px 4px;
    }
    
    .delete-button {
        font-size: 0.55rem;
        padding: 2px 4px;
    }
    

    
    .product-meta {
        font-size: 0.6rem;
    }
    
    .product-meta i {
        font-size: 0.55rem;
    }
    
    .location {
        font-size: 0.6rem;
    }
    
    .location i {
        font-size: 0.55rem;
    }
}

@media (max-width: 360px) {
    .product-image-container {
        height: 90px;
    }
    
    .product-content {
        padding: 5px;
    }
    
    .product-title {
        font-size: 0.7rem;
    }
    

}

/* Touch-friendly interactions */
@media (hover: none) and (pointer: coarse) {
    .product-card:hover {
        transform: none !important;
        box-shadow: none !important;
    }
    
    .product-card:active {
        transform: scale(0.95) !important;
        transition: transform 0.1s ease !important;
    }
    
    .delete-button:hover {
        transform: none !important;
    }
    
    .delete-button:active {
        transform: scale(0.95) !important;
    }
    

    
    /* Ensure clickability */
    .product-card,
    .delete-button {
        pointer-events: auto !important;
        cursor: pointer !important;
        -webkit-tap-highlight-color: transparent !important;
    }
}

/* Loading state */
.product-card.loading {
    opacity: 0.6;
    pointer-events: none;
}

/* Focus states for accessibility */
.product-card:focus {
    outline: 2px solid #667eea;
    outline-offset: 2px;
}
</style>

<div class="product-card" data-product-url="{% url 'app:product_detail' product.pk %}">
    <!-- Delete Button for User Dashboard -->
    {% if is_user_dashboard %}
    <a href="{% url 'app:delete_user_product' product.pk %}" class="delete-button" onclick="return confirm('آیا مطمئن هستید که می‌خواهید این محصول را حذف کنید؟')">حذف</a>
    {% endif %}
    
    <!-- Product Badge -->
    {% if product.is_featured %}
    <span class="product-badge badge-featured">ویژه</span>
    {% elif product.is_discounted %}
    <span class="product-badge badge-discounted">تخفیف</span>
    {% elif product.is_suggested %}
    <span class="product-badge badge-suggested">پیشنهاد</span>
    {% endif %}
    
    <!-- Product Image -->
    <div class="product-image-container">
        {% if product.images.first %}
        <img src="{{ product.images.first.image.url }}" class="product-image" alt="{{ product.name_fa|default:product.name_en|default:product.name_ps }}">
        {% else %}
        <img src="{% static 'logo-1.png' %}" class="product-image" alt="تصویر موجود نیست">
        {% endif %}
    </div>
    
    <!-- Product Content -->
    <div class="product-content">
        <!-- Product Title -->
        <h3 class="product-title">{{ product.name_fa|default:product.name_en|default:product.name_ps }}</h3>
        
        <!-- Product Tags -->
        <div class="product-tags">
            <!-- Other Tags -->
            {% for tag in product.tags.all %}
                {% if tag.name_fa != 'نو' and tag.name_fa != 'دست دوم' %}
                <span class="condition-badge badge-new">{{ tag.name_fa }}</span>
                {% endif %}
            {% endfor %}
        </div>
        
        <!-- Product Meta -->
        <div class="product-meta">
            <i class="bi bi-clock"></i>
            <span>{{ product.created_at|naturaltime }}</span>
        </div>
        
        <!-- Product Price -->
        <div class="product-price">
            <div class="price-container">
                {% if product.discount_price %}
                <span class="original-price">{{ product.price }} افغانی</span>
                <span class="discount-price">{{ product.discount_price }} افغانی</span>
                {% elif product.price %}
                <span class="current-price">{{ product.price }} افغانی</span>
                {% else %}
                <span class="current-price">قیمت نامشخص</span>
                {% endif %}
            </div>
            
            <!-- Location -->
            <div class="location">
                <i class="bi bi-geo-alt"></i>
                <span>{% if product.city %}{{ product.city }}{% else %}نامشخص{% endif %}</span>
            </div>
        </div>
        

    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const productCards = document.querySelectorAll('.product-card[data-product-url]');
    
    productCards.forEach(card => {
        // Make entire card clickable
        card.addEventListener('click', function(event) {
                    // Don't navigate if delete button was clicked
        if (!event.target.closest('.delete-button')) {
                const url = this.getAttribute('data-product-url');
                if (url) {
                    window.location.href = url;
                }
            }
        });
        
        // Desktop mouse events for better experience
        card.addEventListener('mousedown', function(event) {
            if (event.button === 0) { // Left click only
                this.style.transform = 'scale(0.98)';
                this.style.transition = 'transform 0.1s ease';
            }
        });
        
        card.addEventListener('mouseup', function() {
            this.style.transform = '';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = '';
        });
        
        // Add touch feedback for mobile
        if ('ontouchstart' in window) {
            let startY = 0;
            let startX = 0;
            let hasMoved = false;
            
            card.addEventListener('touchstart', function(e) {
                startY = e.touches[0].clientY;
                startX = e.touches[0].clientX;
                hasMoved = false;
                
                this.style.transform = 'scale(0.95)';
                this.style.transition = 'transform 0.1s ease';
            });
            
            card.addEventListener('touchmove', function(e) {
                const currentY = e.touches[0].clientY;
                const currentX = e.touches[0].clientX;
                const deltaY = Math.abs(currentY - startY);
                const deltaX = Math.abs(currentX - startX);
                
                // If user has scrolled more than 10px, don't trigger click
                if (deltaY > 10 || deltaX > 10) {
                    hasMoved = true;
                }
            });
            
            card.addEventListener('touchend', function(e) {
                this.style.transform = '';
                this.style.transition = '';
                
                // Only trigger click if user hasn't scrolled
                if (!hasMoved) {
                    const url = this.getAttribute('data-product-url');
                    if (url && !e.target.closest('.delete-button')) {
                        window.location.href = url;
                    }
                }
            });
        }
    });
    

    
    // Ensure delete buttons work
    const deleteButtons = document.querySelectorAll('.delete-button');
    deleteButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });
});
</script>
